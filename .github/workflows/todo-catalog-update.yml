name: "TODO Catalog Update"

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  update-todo-catalog:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'TODO') || contains(github.event.head_commit.message, 'FIXME') || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Generate TODO catalog
      run: |
        python scripts/generate_todo_catalog.py
        echo "TODO catalog generation completed"
    
    - name: Update recursive TODO resolution progress
      run: |
        python scripts/recursive_todo_resolver.py --validate-batch-6
        echo "Batch 6 validation completed"
    
    - name: Check for catalog changes
      id: check_changes
      run: |
        git diff --name-only | grep -E "(COMPREHENSIVE-TODO-CATALOG.md|todo_resolution_progress.json)" && echo "changes=true" >> $GITHUB_OUTPUT || echo "changes=false" >> $GITHUB_OUTPUT
    
    - name: Commit updated catalog
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add COMPREHENSIVE-TODO-CATALOG.md todo_resolution_progress.json
        git commit -m "ðŸ¤– Auto-update TODO catalog and resolution progress

        - Updated comprehensive TODO catalog
        - Validated batch 6 TODO resolution progress
        - Automated via CI workflow
        
        Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>" || true
    
    - name: Push changes
      if: steps.check_changes.outputs.changes == 'true' && github.event_name == 'push'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
    
    - name: Comment on PR with TODO summary
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Read TODO catalog if it exists
          let todoCount = 0;
          let resolvedCount = 0;
          
          try {
            const progressData = JSON.parse(fs.readFileSync('todo_resolution_progress.json', 'utf8'));
            todoCount = progressData.completed_todos ? progressData.completed_todos.length : 0;
            resolvedCount = progressData.total_resolved || 0;
          } catch (e) {
            console.log('No progress file found');
          }
          
          const comment = `## ðŸ¤– TODO Catalog Update
          
          **Recursive TODO Resolution Status:**
          - âœ… Completed TODOs: ${todoCount}
          - ðŸŽ¯ Total Resolved: ${resolvedCount}
          - ðŸ”„ Batch 6 validation executed
          
          *This comment was automatically generated by the TODO catalog update workflow.*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });